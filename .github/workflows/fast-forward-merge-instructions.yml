name: PR Instructions for Fast-forward Release

permissions:
  contents: read
  pull-requests: write
  issues: write

on:
  pull_request_target:
    types: [opened, edited]

jobs:
  pr-instructions-comment:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main
      - name: Determine PR Situation
        id: check_situation
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const event = context.payload.action;
            const toMain = pr.base.ref === "main";
            const isRelease = pr.head.ref.startsWith("release/");
            // Detect target branch change in 'edited' event
            let retargetedToMain = false;
            if (
              event === "edited" &&
              context.payload.changes &&
              context.payload.changes.base &&
              pr.base.ref === "main"
            ) {
              retargetedToMain = true;
            }
            core.setOutput('to_main', toMain ? 'true' : 'false');
            core.setOutput('is_release', isRelease ? 'true' : 'false');
            core.setOutput('retargeted_to_main', retargetedToMain ? 'true' : 'false');
            core.setOutput('source_branch', pr.head.ref);

      - name: Comment instructions for release/* branch
        if: |
          (steps.check_situation.outputs.to_main == 'true' && steps.check_situation.outputs.is_release == 'true')
          && (github.event.action == 'opened' || github.event.action == 'reopened' || github.event.action == 'ready_for_review' || steps.check_situation.outputs.retargeted_to_main == 'true')
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const pr_number = context.payload.pull_request.number;
            const source = "${{ steps.check_situation.outputs.source_branch }}";
            const message = fs.readFileSync('.github/workflows/fast-forward-merge/comment-release-instructions.md', 'utf8');

            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: pr_number,
              body: message
            });

      - name: Comment instructions for non-release branches
        if: |
          (steps.check_situation.outputs.to_main == 'true' && steps.check_situation.outputs.is_release != 'true')
          && (github.event.action == 'opened' || github.event.action == 'reopened' || github.event.action == 'ready_for_review' || steps.check_situation.outputs.retargeted_to_main == 'true')
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const pr_number = context.payload.pull_request.number;
            const source = "${{ steps.check_situation.outputs.source_branch }}";
            const message = fs.readFileSync('.github/workflows/fast-forward-merge/comment-source-branch-warning.md', 'utf8');

            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: pr_number,
              body: message
            });
